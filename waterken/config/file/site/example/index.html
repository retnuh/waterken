<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title></title>
<link rel="icon" type="image/gif" href="/site/icon.gif?o=">
<link rel="StyleSheet" type="text/css" href="/site/style.css?o=">
<script type="text/javascript" src="/site/json2.js?o="></script>
<script type="text/javascript" src="/site/adsafe.js?o="></script>
</head>
<body>
<noscript><p>This page requires a Javascript enabled web browser.</p></noscript>
<script type="text/javascript">
// reload the document if the fragment changes
(function () {
    var originalFragment = window.location.hash;
    var checker = function () {
        if (originalFragment !== window.location.hash) {
            // TODO: do original fragment navigation
            window.location.reload();
        } else {
            setTimeout(checker, 100);
        }
    };
    setTimeout(checker, 100);
}());
</script>

<div id="EXAMPLE_">
<!-- Normally, you'd put your widget's initial HTML content here. -->
<!-- For example... -->
<div id="EXAMPLE_ANY" style="display: none"></div>
<div id="EXAMPLE_BANG" style="display: none">
<style type="text/css">
.input, .prompt { color: blue }
.output { color: green }
</style>
<p>Using this page, you can try out the
<a href="/site/ref_send.js?o=2009-05-08">ref_send promise API</a> in the
<a href="https://addons.mozilla.org/firefox/addon/1843">Firebug</a> console.
For example, select the "Console" tab in Firebug and then enter the following
commands at the "<kbd><span class="prompt">&gt;&gt;&gt;</span></kbd>" prompt at
the bottom of the window:</p>
<pre>
<span class="comment">
// This test page refers to a factory object for constructing a
// <a href="http://waterken.sf.net/javadoc/org/waterken/bang/Drum.html">org.waterken.bang.Drum</a> object. A Drum is just a counter object that
// can be incremented. We'll create a new Drum by invoking the factory
// method.</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">drum = lib.Q.post(lib.web.getLocation(), 'makeDrum', [])</span>
<span class="output">function()</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">hits = lib.Q.get(drum, 'hits')</span>
<span class="output">function()</span>
<span class="comment">
// Since I'm just typing in an interactive shell, the response to the
// GET request sent above will already have been received and
// processed by the time I hit the 'Enter' key.</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.near(hits)</span>
<span class="output" id="EXAMPLE_BANG0">waiting...</span>
<span class="comment">
// Send a POST request to increment the counter...</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.post(drum, 'bang', [ 1 ])</span>
<span class="output">function()</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">hits = lib.Q.get(drum, 'hits')</span>
<span class="output">function()</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.near(hits)</span>
<span class="output" id="EXAMPLE_BANG1">waiting...</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.post(drum, 'bang', [ 2 ])</span>
<span class="output">function()</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">hits = lib.Q.get(drum, 'hits')</span>
<span class="output">function()</span>
<span class="comment">
// If we weren't typing in an interactive shell, we might want to setup
// a callback to be invoked after a promise is resolved. We can do this
// using the when() method. Below, we setup two callbacks: one to be
// notified if the promise is fulfilled with a value; and another to be
// notified if the promise is not fulfilled. Each callback simply prints
// a message to stdout.</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.when(hits, function (value) {
        ADSAFE.log('hits = ' + value);
    }, function (reason) {
        ADSAFE.log('request failed');
    })</span>
<span class="output">function()</span>
<span class="comment">
// A promise can also be used to queue up future messages. Below, the
// GET request to query the counter is sent on the promise returned by
// the POST request that increases the counter.</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">hits = lib.Q.get(lib.Q.post(drum, 'bang', [ 3 ]), 'hits')</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.near(hits)</span>
<span class="output" id="EXAMPLE_BANG6">waiting...</span>
<span class="comment">
// Promises can also be used as arguments...</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.post(drum, 'bang', [ hits ])</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">hits = lib.Q.get(drum, 'hits')</span>
<span class="output">function()</span>
<span class="prompt">&gt;&gt;&gt;</span> <span class="input">lib.Q.near(hits)</span>
<span class="output" id="EXAMPLE_BANG12">waiting...</span>
</pre>
</div>
<div id="EXAMPLE_SERIES" style="display: none">
<p><input type="button" id="EXAMPLE_SERIESCONSUME" value="Consume"/> a value:
<span id="EXAMPLE_SERIESSLOT"></span></p>
<p>Produce a value:
<input type="text" autocomplete="off" id="EXAMPLE_SERIESPRODUCE" /></p>
</div>
<script type="text/javascript">
"use strict";
ADSAFE.id('EXAMPLE_');
</script>
<script type="text/javascript" src="/site/ref_send.js?o=2009-05-08"></script>
<script type="text/javascript" src="/site/web_send.js?o=2009-05-08"></script>
<script type="text/javascript">
"use strict";
ADSAFE.go('EXAMPLE_', function (dom, lib) {
    // Promote the widget context...
    window.dom = dom;           // not ADsafe
    window.lib = lib;           // not ADsafe
    // , so that it can be used from the console.

    // Normally, you'd put your code here, instead of writing in the console.
    // For example, ...
    function render(value, $) {
        if (void 0 === $) {
            $ = [];
        }
        var r;
        switch (typeof value) {
        case 'boolean':
            $.push('boolean');
            $.push(value ? 'true' : 'false');
            r = dom.tag('span');
            break;
        case 'number':
            $.push('number');
            r = dom.tag('span').append(dom.text('' + value));
            break;
        case 'string':
            r = dom.tag('span').append(dom.text(value));
            break;
        case 'function':
            var referent = lib.Q.near(value);
            r = dom.tag('a');
            if (lib.web.href(r, referent)) {
                r.append(dom.tag('span').klass('empty').append(dom.text('X')));
            } else {
                r = render(referent, $);
            }
            break;
        default:
            if (void 0 === value || null === value) {
                $.push('void');
                r = dom.tag('span');
            } else if (ADSAFE.isArray(value)) {
                r = dom.tag('ol');
                value.filter(function (element) {
                    r.append(dom.tag('li').append(render(element)));
                });
            } else {
                r = dom.tag('div');
                for (name in value) { if (value.hasOwnProperty(name)) {
                    if ('$' === name) {
                        $ = $.concat(value.$);
                    } else if ('!' === name) {
                        $ = $.concat('Rejected');
                        r.append(render(ADSAFE.get(value, name), [ 'reason' ]));
                        r.append(dom.text(' '));
                    } else {
                        r.append(render(ADSAFE.get(value, name), [ name ]));
                        r.append(dom.text(' '));
                    }
                } }
            }
        }
        if (0 !== $.length) {
            r.klass($.join(' '));
        }
        return r;
    }
    function renderBody(value) {
        var node = render(value);
        dom.q('#EXAMPLE_ANY').
            style('display', 'block').
            append(dom.tag('h1').append(dom.text(node.getClass()))).
            append(node);
    }
    function renderBang(factory) {
        dom.q('#EXAMPLE_BANG').style('display', 'block');
        var drum = lib.Q.post(factory, 'makeDrum', []);
        lib.Q.when(lib.Q.get(drum, 'hits'), function (value) {
            dom.q('#EXAMPLE_BANG0').empty().append(render(value));
        }, function (reason) {
            dom.q('#EXAMPLE_BANG0').empty().append(render(reason));
        });
        lib.Q.post(drum, 'bang', [ 1 ]);
        lib.Q.when(lib.Q.get(drum, 'hits'), function (value) {
            dom.q('#EXAMPLE_BANG1').empty().append(render(value));
        }, function (reason) {
            dom.q('#EXAMPLE_BANG1').empty().append(render(reason));
        });
        lib.Q.post(drum, 'bang', [ 2 ]);
        lib.Q.when(lib.Q.get(drum, 'hits'), function (value) {
            ADSAFE.log('hits = ' + value);
        }, function (reason) {
            ADSAFE.log('request failed');
        });
        lib.Q.when(lib.Q.get(lib.Q.post(drum, 'bang', [ 3 ]), 'hits'),
                   function (value) {
            dom.q('#EXAMPLE_BANG6').empty().append(render(value));

            lib.Q.post(drum, 'bang', [ lib.Q.get(drum, 'hits') ]);
            lib.Q.when(lib.Q.get(drum, 'hits'), function (value) {
                dom.q('#EXAMPLE_BANG12').empty().append(render(value));
            }, function (reason) {
                dom.q('#EXAMPLE_BANG12').empty().append(render(reason));
            });
        }, function (reason) {
            dom.q('#EXAMPLE_BANG6').empty().append(render(reason));
        });
    }
    function update(element, value, $) {
        return function () { return element.empty().append(render(value, $)); };
    }
    function after(p, f) { return lib.Q.when(p, f, f); }
    function renderSeries(series) {
        var ol = dom.tag('ol');
        function grow(pLink) {
            var li = dom.tag('li').append(render(pLink));
            lib.Q.when(pLink, function (link) {
                after(link.value, update(li, link.value));
                grow(link.next);
            }, function (reason) {
                li.empty().append(render(pLink));
            });
            ol.append(li);
        };
        var front = lib.Q.get(series, 'front');
        after(series, function () { grow(front); });
        var slot = dom.q('#EXAMPLE_SERIESSLOT');
        var consume = dom.q('#EXAMPLE_SERIESCONSUME');
        consume.on('click', function (e) {
            var consumed = lib.Q.post(series, 'consume', []);
            after(series, update(slot, consumed));
            after(consumed, update(slot, consumed));
            ol.q('li:first').remove();
        });
        var produce = dom.q('#EXAMPLE_SERIESPRODUCE');
        produce.on('enterkey', function (e) {
            lib.Q.post(series, 'produce', [ produce.getValue() ]);
            produce.value('');
        });
        dom.q('#EXAMPLE_SERIES').style('display', 'block').append(ol);
        produce.focus();
    }
    function renderSeriesFactory(factory) {
        lib.Q.when(lib.Q.post(factory, 'makeSeries', []), function (value) {
            if (!lib.web.navigate(value)) { throw new Error(); }
        }, function (reason) {
            renderBody(reason);
        });
    }
    function isa(value, type) {
        return value && value.$ &&
               value.$.filter(function (x) { return x === type; }).length;
    }
    var target = lib.web.getLocation();
    var representation = lib.Q.get(target);
    lib.Q.when(representation, function (value) {
        if (isa(value, 'org.waterken.bang.DrumFactory')) {
            renderBang(target);
        } else if (isa(value, 'org.waterken.serial.Series')) {
            renderSeries(target);
        } else if (isa(value, 'org.waterken.serial.SeriesFactory')) {
            renderSeriesFactory(target);
        } else {
            renderBody(value);
        }
    }, function (reason) {
        renderBody(representation);
    });
});
</script>
</div>

</body>
</html>
